{% extends "base.html" %}
{% block content %}

{% include 'student_steps.html' %}

<div class="form-container">
    <h2 class="glow-title">القسم الثالث: المواد الدراسية</h2>

    {% if courses %}
    <h3 class="section-heading">المواد المسجلة حالياً (الإجمالي: {{ total_credits }} وحدة)</h3>
    <div class="table-responsive" style="margin-bottom: 25px;">
        <table class="data-table">
            <thead>
                <tr>
                    <th>المادة</th>
                    <th>الفصل</th>
                    <th>الوحدات</th>
                    <th>إجراء</th>
                </tr>
            </thead>
            <tbody>
                {% for course in courses %}
                <tr>
                    <td>{{ course.course_name }}</td>
                    <td>{{ course.semester }}</td>
                    <td>{{ course.credits }}</td>
                    <td>
                        <form action="{{ url_for('courses') }}" method="POST" class="delete-form" style="display:inline;"
                              onsubmit="return confirm('هل أنت متأكد من حذف هذه المادة؟');">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <input type="hidden" name="action" value="delete">
                            <input type="hidden" name="course_id" value="{{ course.id }}">
                            <button type="submit" class="action-btn delete-link" style="padding: 5px 10px;">حذف</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p class="no-data-message">لا توجد مواد مسجلة لهذا الطالب حالياً.</p>
    {% endif %}

    <h3 class="section-heading">إضافة مواد جديدة</h3>
    
    <datalist id="courses-list">
        {% for ac in available_courses %}
            <option value="{{ ac.course_name }}" data-credits="{{ ac.default_credits }}"></option>
        {% endfor %}
    </datalist>

    <form method="POST" id="courses-form">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        
        <div id="course-fields">
            <div class="course-row">
                <div class="input-box" style="flex: 3;">
                    <label>اسم المادة (اختر أو اكتب جديد)</label>
                    <input type="text" name="course_name[]" list="courses-list" placeholder="ابحث عن مادة..." onchange="autoFillCredits(this)">
                </div>

                <div class="input-box" style="flex: 2;">
                    <label>الفصل</label>
                    <select name="course_term[]">
                        <option value="كورس أول">كورس أول</option>
                        <option value="كورس ثاني">كورس ثاني</option>
                        <option value="صيفي">صيفي</option>
                    </select>
                </div>

                <div class="input-box" style="flex: 1;">
                    <label>الوحدات</label>
                    <input type="number" name="course_units[]" class="credits-input" placeholder="وحدة" min="1">
                </div>
                <button type="button" class="remove-btn" onclick="removeRow(this)" style="display:none; height: 40px; margin-top: 25px;">حذف</button>
            </div>
        </div>

        <button type="button" onclick="addRow()" class="add-btn">إضافة مادة أخرى +</button>

        <div class="btn-box">
            <a href="{{ url_for('admission') }}" class="back-btn">رجوع</a>
            <button type="submit" class="next-btn">التالي</button>
        </div>
    </form>
</div>

<script>
    // دالة الملء التلقائي للوحدات عند اختيار مادة
    function autoFillCredits(input) {
        const val = input.value;
        const list = document.getElementById('courses-list');
        const options = list.options;
        
        for (let i = 0; i < options.length; i++) {
            if (options[i].value === val) {
                // العثور على الحقل المجاور للوحدات
                const row = input.closest('.course-row');
                const creditsInput = row.querySelector('.credits-input');
                const credits = options[i].getAttribute('data-credits');
                if (credits && creditsInput) {
                    creditsInput.value = credits;
                }
                break;
            }
        }
    }

    function addRow() {
        const fields = document.getElementById('course-fields');
        const newRow = document.createElement('div');
        newRow.className = 'course-row';
        
        // نفس الـ HTML لكن مع إضافة دالة autoFillCredits
        newRow.innerHTML = `
            <div class="input-box" style="flex: 3;">
                <input type="text" name="course_name[]" list="courses-list" placeholder="ابحث عن مادة..." onchange="autoFillCredits(this)" required>
            </div>
            <div class="input-box" style="flex: 2;">
                <select name="course_term[]">
                    <option value="كورس أول">كورس أول</option>
                    <option value="كورس ثاني">كورس ثاني</option>
                    <option value="صيفي">صيفي</option>
                </select>
            </div>
            <div class="input-box" style="flex: 1;">
                <input type="number" name="course_units[]" class="credits-input" placeholder="وحدة" min="1" required>
            </div>
            <button type="button" class="remove-btn" onclick="removeRow(this)" style="height: 40px; margin-top: 25px;">حذف</button>
        `;
        fields.appendChild(newRow);
    }

    function removeRow(btn) {
        const fields = document.getElementById('course-fields');
        if (fields.childElementCount > 1) {
            btn.parentElement.remove();
        } else {
            alert('يجب ترك صف واحد على الأقل.');
        }
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        const rows = document.getElementById('course-fields').children;
        if (rows.length > 1) {
            Array.from(rows).forEach(row => {
                const removeBtn = row.querySelector('.remove-btn');
                if (removeBtn) removeBtn.style.display = 'block';
            });
        }
    });
</script>

{% endblock %}