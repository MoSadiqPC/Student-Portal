{% extends "base.html" %}
{% block content %}

{% include 'student_steps.html' %}

<section class="card form-container">
    <h2 class="glow-title">القسم السادس: لجنة المناقشة والخطة</h2>

    <form method="POST">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

        <div class="input-box">
            <label>اسم اللجنة / العنوان المقترح للمناقشة</label>
            <input type="text" name="committee_name" value="{{ data.committee_name if data else '' }}" required>
        </div>
        
        <div class="input-grid-2">
            <div class="input-box">
                <label>المشرف (يُحمّل من البحث)</label>
                <input type="text" name="supervisor" value="{{ data.supervisor if data else '' }}" readonly class="readonly-input" required>
            </div>

            <div class="input-box">
                <label>تاريخ المناقشة المقترح</label>
                <input type="date" name="discussion_date" value="{{ data.discussion_date if data else '' }}">
            </div>
        </div>

        <h3 class="section-heading" style="margin-top: 30px;">أعضاء اللجنة الحاليون</h3>
        <div id="current-members-display" style="margin-bottom: 15px; display: flex; flex-wrap: wrap; gap: 10px;">
            {% if data.members %}
                {% for member in data.members.split(',') %}
                    {% set member = member | trim %}
                    {% if member %}
                        <span class="member-tag" style="display: flex; align-items: center; background-color: #00ff7f20; color: #00ff7f; padding: 5px 10px; border-radius: 5px; font-size: 0.9em;">
                            {{ member }}
                            <button type="submit" name="action" value="delete_member" 
                                style="background: none; border: none; color: #ff4f4f; margin-left: 8px; font-weight: bold; cursor: pointer; padding: 0;"
                                onclick="this.form.member_to_delete.value='{{ member }}'; return confirm('حذف؟')">
                                &times;
                            </button>
                        </span>
                    {% endif %}
                {% endfor %}
            {% else %}
                <p style="color: #888;">لا يوجد أعضاء مضافون حالياً.</p>
            {% endif %}
        </div>
        <input type="hidden" name="member_to_delete" value="">

        <h3 class="section-heading" style="margin-top: 30px;">إضافة أعضاء جدد</h3>
        <div id="member-fields">
            <div class="course-row member-row">
                <div class="input-box" style="flex: 1; margin-bottom: 0;">
                    <input type="text" name="new_member[]" placeholder="اسم عضو اللجنة (أ.د / د.)">
                </div>
                <button type="button" class="remove-btn" onclick="removeMemberRow(this)" style="display:none;">حذف</button>
            </div>
        </div>
        <button type="button" onclick="addMemberRow()" class="add-btn" style="margin-bottom: 20px;">+ إضافة عضو آخر</button>

        <div class="input-box">
            <label>ملاحظات حول الخطة / التوصيات</label>
            <textarea name="notes" rows="3">{{ data.notes if data else '' }}</textarea>
        </div>

        <div class="btn-box form-actions">
            <a class="back-btn" href="{{ url_for('competency') }}">رجوع</a>
            <button class="next-btn" type="submit" name="action" value="save">التالي</button>
        </div>

    </form>
</section>

<script>
    function addMemberRow() {
        const fields = document.getElementById('member-fields');
        const newRow = document.createElement('div');
        newRow.className = 'course-row member-row';
        newRow.innerHTML = `
            <div class="input-box" style="flex: 1; margin-bottom: 0;">
                <input type="text" name="new_member[]" placeholder="اسم عضو اللجنة (أ.د / د.)">
            </div>
            <button type="button" class="remove-btn" onclick="removeMemberRow(this)">حذف</button>
        `;
        fields.appendChild(newRow);
        fields.querySelectorAll('.member-row button').forEach(btn => btn.style.display = 'block');
    }

    function removeMemberRow(btn) {
        const fields = document.getElementById('member-fields');
        if (fields.childElementCount > 1) {
            btn.closest('.member-row').remove();
        }
        if (fields.childElementCount === 1) {
             fields.querySelector('.member-row button').style.display = 'none';
        }
    }
</script>
{% endblock %}